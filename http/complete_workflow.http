### Complete Business Workflow Test
### This file tests the complete student registration system workflow with JWT Authentication

### ===========================================
### PHASE 0: AUTHENTICATION - Get Tokens
### ===========================================

### 1. Register new student
POST http://localhost:8080/api/v1/auth/register
Content-Type: application/json

{
  "firstName": "New",
  "lastName": "Student",
  "email": "new.student@example.com",
  "password": "password123",
  "dateOfBirth": "2000-01-01"
}

> {%
client.global.set("new_student_token", response.body.data.token);
%}

### 2. Login as Admin
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "password123"
}

> {%
client.global.set("admin_token", response.body.data.token);
%}

### 3. Login as Lecturer
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "lecturer@example.com",
  "password": "password123"
}

> {%
client.global.set("lecturer_token", response.body.data.token);
%}

### 4. Login as Student
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "student@example.com",
  "password": "password123"
}

> {%
client.global.set("student_token", response.body.data.token);
%}

### ===========================================
### PHASE 1: SETUP - Create Users and Roles
### ===========================================

### 5. Test newly registered student access (using new student token)
GET http://localhost:8080/api/v1/auth/me
Authorization: Bearer {{new_student_token}}

### 6. Test newly registered student can access courses (using new student token)
GET http://localhost:8080/api/v1/courses
Authorization: Bearer {{new_student_token}}

### 7. Create Admin User (using admin token)
POST http://localhost:8080/api/v1/users
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "firstName": "Admin",
  "lastName": "User",
  "email": "admin@university.edu",
  "password": "admin123",
  "role": "Admin"
}

### 8. Create Lecturer (using admin token)
POST http://localhost:8080/api/v1/lecturers
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "firstName": "Dr. Jane",
  "lastName": "Smith",
  "email": "jane.smith@university.edu",
  "password": "lecturer123",
  "specialization": "Computer Science",
  "phoneNumber": "+1234567890",
  "hireDate": "2020-01-15"
}

### 9. Create Student 1 (using admin token)
POST http://localhost:8080/api/v1/students
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "firstName": "Alice",
  "lastName": "Johnson",
  "email": "alice.johnson@university.edu",
  "password": "student123",
  "dateOfBirth": "2000-05-15",
  "phoneNumber": "+1987654321",
  "address": "123 University Ave, Campus City, State 12345",
  "enrollmentDate": "2024-01-15"
}

### 10. Create Student 2 (using admin token)
POST http://localhost:8080/api/v1/students
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "firstName": "Bob",
  "lastName": "Wilson",
  "email": "bob.wilson@university.edu",
  "password": "student123",
  "dateOfBirth": "1999-08-22",
  "phoneNumber": "+1122334455",
  "address": "456 College St, Campus City, State 12345",
  "enrollmentDate": "2024-01-20"
}

### ===========================================
### PHASE 2: COURSE MANAGEMENT
### ===========================================

### 11. Create Course 1 - Computer Science (using admin token)
POST http://localhost:8080/api/v1/courses
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "courseCode": "CS101",
  "title": "Introduction to Computer Science",
  "description": "A comprehensive introduction to computer science fundamentals including programming, algorithms, and data structures",
  "credits": 3,
  "lecturerId": 1,
  "startDate": "2024-09-01",
  "endDate": "2024-12-15",
  "capacity": 30,
  "courseMetadata": "{\"prerequisites\": [], \"department\": \"Computer Science\", \"difficulty\": \"beginner\"}"
}

### 12. Create Course 2 - Mathematics (using admin token)
POST http://localhost:8080/api/v1/courses
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "courseCode": "MATH201",
  "title": "Calculus I",
  "description": "Introduction to differential and integral calculus with applications",
  "credits": 4,
  "startDate": "2024-09-01",
  "endDate": "2024-12-15",
  "capacity": 25,
  "courseMetadata": "{\"prerequisites\": [\"MATH101\"], \"department\": \"Mathematics\", \"difficulty\": \"intermediate\"}"
}

### 13. Create Course 3 - Advanced CS (using admin token)
POST http://localhost:8080/api/v1/courses
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "courseCode": "CS301",
  "title": "Data Structures and Algorithms",
  "description": "Advanced study of data structures and algorithm design",
  "credits": 4,
  "lecturerId": 1,
  "startDate": "2024-09-01",
  "endDate": "2024-12-15",
  "capacity": 20,
  "courseMetadata": "{\"prerequisites\": [\"CS101\"], \"department\": \"Computer Science\", \"difficulty\": \"advanced\"}"
}

### ===========================================
### PHASE 3: ENROLLMENT WORKFLOW
### ===========================================

### 14. Student 1 enrolls in CS101 (using student token)
POST http://localhost:8080/api/v1/enrollments
Content-Type: application/json
Authorization: Bearer {{student_token}}

{
  "studentId": 1,
  "courseId": 1
}

### 15. Student 1 enrolls in MATH201 (using student token)
POST http://localhost:8080/api/v1/enrollments
Content-Type: application/json
Authorization: Bearer {{student_token}}

{
  "studentId": 1,
  "courseId": 2
}

### 16. Student 2 enrolls in CS101 (using student token)
POST http://localhost:8080/api/v1/enrollments
Content-Type: application/json
Authorization: Bearer {{student_token}}

{
  "studentId": 2,
  "courseId": 1
}

### 17. Student 2 enrolls in CS301 (using student token)
POST http://localhost:8080/api/v1/enrollments
Content-Type: application/json
Authorization: Bearer {{student_token}}

{
  "studentId": 2,
  "courseId": 3
}

### 18. Newly registered student enrolls in CS101 (using new student token)
POST http://localhost:8080/api/v1/enrollments
Content-Type: application/json
Authorization: Bearer {{new_student_token}}

{
  "studentId": 3,
  "courseId": 1
}

### ===========================================
### PHASE 4: GRADING WORKFLOW
### ===========================================

### 19. Lecturer grades Student 1 in CS101 (using lecturer token)
PUT http://localhost:8080/api/v1/enrollments/1
Content-Type: application/json
Authorization: Bearer {{lecturer_token}}

{
  "grade": 8.5
}

### 20. Lecturer grades Student 1 in MATH201 (using lecturer token)
PUT http://localhost:8080/api/v1/enrollments/2
Content-Type: application/json
Authorization: Bearer {{lecturer_token}}

{
  "grade": 9.2
}

### 21. Lecturer grades Student 2 in CS101 (using lecturer token)
PUT http://localhost:8080/api/v1/enrollments/3
Content-Type: application/json
Authorization: Bearer {{lecturer_token}}

{
  "grade": 7.8
}

### 22. Lecturer grades Student 2 in CS301 (using lecturer token)
PUT http://localhost:8080/api/v1/enrollments/4
Content-Type: application/json
Authorization: Bearer {{lecturer_token}}

{
  "grade": 9.5
}

### 23. Lecturer grades newly registered student in CS101 (using lecturer token)
PUT http://localhost:8080/api/v1/enrollments/5
Content-Type: application/json
Authorization: Bearer {{lecturer_token}}

{
  "grade": 8.8
}

### ===========================================
### PHASE 5: LECTURER DASHBOARD
### ===========================================

### 24. Lecturer views their courses (using lecturer token)
GET http://localhost:8080/api/v1/lecturers/1/courses?page=0&size=10
Authorization: Bearer {{lecturer_token}}

### 25. Lecturer views all their students (using lecturer token)
GET http://localhost:8080/api/v1/lecturers/1/students?page=0&size=10
Authorization: Bearer {{lecturer_token}}

### 26. Lecturer views students in specific course (using lecturer token)
GET http://localhost:8080/api/v1/lecturers/1/courses/1/students?page=0&size=10
Authorization: Bearer {{lecturer_token}}

### 27. Lecturer views their statistics (using lecturer token)
GET http://localhost:8080/api/v1/lecturers/1/stats
Authorization: Bearer {{lecturer_token}}

### ===========================================
### PHASE 6: ADMIN DASHBOARD
### ===========================================

### 28. Admin views dashboard overview (using admin token)
GET http://localhost:8080/api/v1/admin/dashboard
Authorization: Bearer {{admin_token}}

### 29. Admin views all enrollments (using admin token)
GET http://localhost:8080/api/v1/admin/enrollments?page=0&size=10
Authorization: Bearer {{admin_token}}

### 30. Admin views recent enrollments (using admin token)
GET http://localhost:8080/api/v1/admin/enrollments/recent?days=7&page=0&size=10
Authorization: Bearer {{admin_token}}

### 31. Admin views active students (using admin token)
GET http://localhost:8080/api/v1/admin/students/active?page=0&size=10
Authorization: Bearer {{admin_token}}

### 32. Admin views popular courses (using admin token)
GET http://localhost:8080/api/v1/admin/courses/popular?page=0&size=10
Authorization: Bearer {{admin_token}}

### 33. Admin views enrollment trends (using admin token)
GET http://localhost:8080/api/v1/admin/reports/enrollment-trends?startDate=2024-01-01&endDate=2024-12-31
Authorization: Bearer {{admin_token}}

### ===========================================
### PHASE 7: STUDENT DASHBOARD
### ===========================================

### 34. Student 1 views their enrollments (using student token)
GET http://localhost:8080/api/v1/enrollments/student/1?page=0&size=10
Authorization: Bearer {{student_token}}

### 35. Student 2 views their enrollments (using student token)
GET http://localhost:8080/api/v1/enrollments/student/2?page=0&size=10
Authorization: Bearer {{student_token}}

### 36. Newly registered student views their enrollments (using new student token)
GET http://localhost:8080/api/v1/enrollments/student/3?page=0&size=10
Authorization: Bearer {{new_student_token}}

### ===========================================
### PHASE 8: COURSE DROPPING
### ===========================================

### 37. Student 1 drops MATH201 (using student token)
PUT http://localhost:8080/api/v1/enrollments/2/drop
Authorization: Bearer {{student_token}}

### 38. Student 2 drops CS301 (using student token)
PUT http://localhost:8080/api/v1/enrollments/4/drop
Authorization: Bearer {{student_token}}

### ===========================================
### PHASE 9: FINAL VERIFICATION
### ===========================================

### 39. Verify Student 1's final enrollments (using student token)
GET http://localhost:8080/api/v1/enrollments/student/1?page=0&size=10
Authorization: Bearer {{student_token}}

### 40. Verify Student 2's final enrollments (using student token)
GET http://localhost:8080/api/v1/enrollments/student/2?page=0&size=10
Authorization: Bearer {{student_token}}

### 41. Verify newly registered student's final enrollments (using new student token)
GET http://localhost:8080/api/v1/enrollments/student/3?page=0&size=10
Authorization: Bearer {{new_student_token}}

### 42. Verify CS101 enrollments (using lecturer token)
GET http://localhost:8080/api/v1/enrollments/course/1?page=0&size=10
Authorization: Bearer {{lecturer_token}}

### 43. Verify MATH201 enrollments (using lecturer token)
GET http://localhost:8080/api/v1/enrollments/course/2?page=0&size=10
Authorization: Bearer {{lecturer_token}}

### 44. Verify CS301 enrollments (using lecturer token)
GET http://localhost:8080/api/v1/enrollments/course/3?page=0&size=10
Authorization: Bearer {{lecturer_token}}

### 45. Final admin dashboard check (using admin token)
GET http://localhost:8080/api/v1/admin/dashboard
Authorization: Bearer {{admin_token}}

### 46. Final enrollment statistics (using admin token)
GET http://localhost:8080/api/v1/enrollments/stats
Authorization: Bearer {{admin_token}}

### ===========================================
### PHASE 10: AUTHENTICATION TESTS
### ===========================================

### 47. Test unauthorized access (should fail)
GET http://localhost:8080/api/v1/users
# No Authorization header - should return 401

### 48. Test student accessing admin endpoint (should fail)
GET http://localhost:8080/api/v1/admin/dashboard
Authorization: Bearer {{student_token}}
# Student token accessing admin endpoint - should return 403

### 49. Test lecturer accessing admin endpoint (should fail)
GET http://localhost:8080/api/v1/admin/dashboard
Authorization: Bearer {{lecturer_token}}
# Lecturer token accessing admin endpoint - should return 403

### 50. Test newly registered student accessing admin endpoint (should fail)
GET http://localhost:8080/api/v1/admin/dashboard
Authorization: Bearer {{new_student_token}}
# Newly registered student token accessing admin endpoint - should return 403

### 51. Test token refresh
POST http://localhost:8080/api/v1/auth/refresh
Content-Type: application/json
Authorization: Bearer {{admin_token}}

{
  "refreshToken": "{{admin_token}}"
}

### 52. Test current user info
GET http://localhost:8080/api/v1/auth/me
Authorization: Bearer {{admin_token}}

### 53. Test newly registered student current user info
GET http://localhost:8080/api/v1/auth/me
Authorization: Bearer {{new_student_token}}

### 54. Test logout
POST http://localhost:8080/api/v1/auth/logout
Authorization: Bearer {{admin_token}}
